name: Build & Test
"on":
  push:
    branches:
      - "**"
jobs:
  build:
    name: Build & Test
    strategy:
      matrix:
        os:
          - ubuntu-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Setup `packer`
        uses: hashicorp/setup-packer@main
        id: setup
        with:
          version: ${{ env.PRODUCT_VERSION }}
      - name: Run `packer init`
        id: init
        run: packer init .
      - name: Run `packer fmt`
        id: fmt
        run: packer fmt -check .
      - name: Run `packer validate`
        id: validate
        run: packer validate -syntax-only .
      - name: Install incus
        run: |
          curl https://pkgs.zabbly.com/get/incus-stable | sudo sh -x
      - name: Reset the firewall
        run: |
          sudo nft flush ruleset
      - name: Init incus
        run: sudo incus admin init --auto
      - uses: hashicorp/setup-terraform@v3
      - name: Test
        run: sudo bash -xe run.sh
  required-check:
    name: All Tests Passed
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - run: echo "All tests passed!"
